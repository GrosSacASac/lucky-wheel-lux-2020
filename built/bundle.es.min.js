function e(t){if((t||this)._callbacks=Object.create(null),t)return Object.assign(t,e.prototype)}e.prototype.on=function(e,t){(this._callbacks[e]=this._callbacks[e]||[]).push(t)},e.prototype.once=function(e,t){const n=o=>{this.off(e,n),t(o)};n.fn=t,this.on(e,n)},e.prototype.off=function(e,t){if(!e)return void(this._callbacks=Object.create(null));const n=this._callbacks[e];if(!n)return;if(!t)return void delete this._callbacks[e];const o=n.findIndex((function(e){return e===t||e.fn===t}));o>-1&&(1===n.length?delete this._callbacks[e]:n.splice(o,1))},e.prototype.emit=function(e,t){const n=this._callbacks[e];if(!n)return;Array.from(n).forEach((e=>{e(t)}))},e.prototype.listeners=function(e){return this._callbacks[e]||[]},e.prototype.hasListeners=function(e){return Boolean(this.listeners(e).length)},e.prototype.eventNames=function(){return Reflect.ownKeys(this._callbacks)},e.prototype.eventNamesStrings=function(){return Object.keys(this._callbacks)};const t=e=>{if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return e.map(t);const n={};return Object.entries(e).forEach((([e,o])=>{n[e]=t(o)})),n},n=e=>{if("object"!=typeof e||null===e)return e;if(e instanceof Date)return new Date(e);if(e instanceof RegExp)return new RegExp(e);if(e instanceof Set)return new Set(Array.from(e,n));if(e instanceof Map){const t=new Map;return e.forEach(((e,o)=>{t.set(n(o),n(e))})),t}if(Array.isArray(e))return e.map(t);if(ArrayBuffer.isView(e)&&!(e instanceof DataView))return new e.constructor(e);const o={};return Object.entries(e).forEach((([e,n])=>{o[e]=t(n)})),o},o=Symbol(),r=Symbol(),s=e=>"object"==typeof e&&null!==e,a=function(e,t){const n=t(e);if(n)return n;const o=e.parentNode;return o?a(o,t):void 0},i=(e,t,n)=>{Object.prototype.hasOwnProperty.call(e,t)?e[t].push(n):e[t]=[n]},{hasOwnProperty:c}=Object.prototype,l=e=>{e.remove()},u=(e,t)=>{t(e);let n=e.firstChild;for(;n;)1===n.nodeType?(u(n,t),n=n.nextElementSibling):n=n.nextSibling},m=e=>{const t=e.getAttribute("is");return t||e.tagName.toLowerCase()},d=e=>(e||console.error('Template missing <template data-template="d-name">\n                Template Content\n            </template>'),e.content||console.error("template.content is undefined, this can happen if a template is inside another template. Use only top level templates, also use recommended polyfills"),document.importNode(e.content,!0)),p=e=>e.join(">"),f=(e,t)=>0===e.length?t:`${p(e)}>${t}`,h=e=>e?`${e}>`:e,g=(e,t="")=>{Object.keys(e).forEach((n=>{n.startsWith(t)&&delete e[n]}))},b=(e,...t)=>{let n;return n=Array.isArray(e)?e.concat(t):[e,...t],p(n)},y=(e,t)=>{e.push(t)},E=e=>{e.pop()},v=(e,t,n)=>{t[e.propertyFromElement(t)]=n},S=(e,t,n,o,r,s)=>{c.call(e,"dom99_X")&&c.call(o,e.dom99_X)?r(e,t,n):_(e,n,s)},_=(e,t,n)=>{const o=document.createDocumentFragment();e.innerHTML="";const r=e.dom99_I,a=n.propertyFromElement(r.toUpperCase());t.forEach((e=>{const t=document.createElement(r);s(e)?Object.assign(t,e):t[a]=e,o.appendChild(t)})),e.appendChild(o)},I=e=>t=>Object.prototype.hasOwnProperty.call(e,t)?e[t]:e.MISS,A=I({INPUT:"value",TEXTAREA:"value",PROGRESS:"value",SELECT:"value",IMG:"src",SOURCE:"src",AUDIO:"src",VIDEO:"src",TRACK:"src",SCRIPT:"src",OPTION:"value",LINK:"href",DETAILS:"open",MISS:"textContent"}),O=I({checkbox:"checked",radio:"checked",MISS:"value"}),$=I({checkbox:"change",radio:"change",range:"change",file:"change",MISS:"input"}),N=I({SELECT:"change",TEXTAREA:"input",BUTTON:"click",FORM:"submit",MISS:"click"}),w={doneSymbol:"*",tokenSeparator:"-",listSeparator:" ",firstVariableValueStrategy:e=>e.value||(e=>void 0!==e.defaultValue?e.defaultValue:void 0!==e.open?e.open:e.textContent)(e),directives:{function:"data-function",variable:"data-variable",element:"data-element",list:"data-list",scope:"data-scope",template:"data-template",use:"data-use"},propertyFromElement:e=>{let t;return void 0!==e.tagName?({tagName:t}=e):t=e,"INPUT"===t?O(e.type):A(t)},eventNameFromElement:e=>{const{tagName:t}=e;return"INPUT"===t?$(e.type):N(t)},tagNamesForUserInput:["INPUT","TEXTAREA","SELECT","DETAILS"]},{start:T,elements:P,functions:j,variables:L,get:k,element:M,feed:C,plugin:R}=(e=>{const t={},n={},o={},r={},a={},_={};let I=[];const A=[];let O=!1;const $=[],N=[],w=(e,s,i)=>{const u=document.createDocumentFragment(),m=a[e.dom99_X],d=Array.from(I);I=s.split(">");const p=h(s),f=i.length;let b,y;if(c.call(e,"dom99_R")){if(b=e.dom99_R.length,b>f){for(let s=f;s<b;s+=1)y=`${p}${s}`,e.dom99_R[s].forEach(l),g(t,E=y),g(n,E),g(o,E),g(r,E);e.dom99_R.length=f}}else e.dom99_R=[],b=0;var E;i.forEach(((t,n)=>{if(y=`${p}${n}`,T(y,t),n<b)return;const o=L(m,String(n));e.dom99_R.push(Array.from(o.childNodes)),u.appendChild(o)})),I=d,e.appendChild(u)},T=(r,i)=>{if(void 0===i&&(i=r,r=""),s(r)&&console.error("Incorrect types passed to d.feed,\n                d.feed(string, object) or d.feed(object)"),O||(D(r,i),O=!0),s(i))if(Array.isArray(i))o[r]=i,c.call(n,r)&&((e,t,n,o,r,s)=>{e.forEach((e=>{S(e,t,n,o,r,s)}))})(n[r],r,i,a,w,e);else{const e=h(r),t=Object.entries(i);t.sort((([e,t],[n,o])=>Number(Array.isArray(o))-Number(Array.isArray(t)))),t.forEach((([t,n])=>{T(`${e}${t}`,n)}))}else o[r]=i,c.call(t,r)&&((e,t,n)=>{void 0!==n&&t.forEach((t=>{v(e,t,n)}))})(e,t[r],i);O=!1},P=(e,t,n)=>{_[n]||console.error(`Event listener ${n} not found.`),e.addEventListener(t,_[n],!1),I.length&&(e.dom99_C=p(I))};let j=P;const L=(e,t)=>{y(I,t);const n=d(e);return C(n),R(),E(I),n},k=[[e.directives.element,(t,n)=>{const o=n;o||console.error(t,`Use ${e.directives.element}="elementName" format!`);const s=f(I,o);r[s]=t}],[e.directives.template,(t,n)=>{if(n||console.error(t,`Use ${e.directives.template}="d-name" format!`),"TEMPLATE"!==t.tagName){const{innerHTML:e}=t;(t=document.createElement("template")).innerHTML=e}a[n]=t}],[e.directives.list,(t,r)=>{const[s,l,u]=r.split(e.tokenSeparator);if(s||console.error(t,`Use ${e.directives.list}="variableName-tagName" format!`),l){let e;u?(e=`${l}-${u}`,t.dom99_X=e):t.dom99_I=l;const n=t.tagName.toLowerCase();console.warn(`deprecated since 21.0.1\nReplace <${n} data-list="${s}-${e||l}"></${n}> with\n<${n} data-list="${s}" data-use="${e||l}"></${n}>`)}else{const n=t.getAttribute(e.directives.use);n.includes("-")?t.dom99_X=n:t.dom99_I=n}const m=f(I,s);if(i(n,m,t),t.childNodes.length>0){y(I,s);const e=Array.from(t.childNodes).filter((e=>1===e.nodeType)),n=p(I);void 0===o[n]&&(o[n]=Array.from({length:e.length},(()=>({})))),t.dom99_R=[],e.forEach(((e,n)=>{y(I,String(n)),C(e),t.dom99_R.push([e,...e.childNodes]),E(I)})),E(I)}c.call(o,m)&&S(t,m,o[m],a,w,e)}],[e.directives.variable,(n,r)=>{r||console.error(n,`Use ${e.directives.variable}="variableName" format!`);const s=f(I,r);i(t,s,n);let a=o[s];if(void 0===a&&void 0!==e.firstVariableValueStrategy&&(a=e.firstVariableValueStrategy(n)),void 0!==a&&(o[s]=a,v(e,n,a)),!e.tagNamesForUserInput.includes(n.tagName))return;n.addEventListener(e.eventNameFromElement(n),(()=>{const r=n[e.propertyFromElement(n)];o[s]=r,D(s,r),t[s].forEach((t=>{t!==n&&v(e,t,r)}))}),!1)}],[e.directives.function,(t,n)=>{n.split(e.listSeparator).forEach((n=>{const o=n.split(e.tokenSeparator);let r,s;1===o.length?(r=o[0],s=e.eventNameFromElement(t)):[s,r]=o,j(t,s,r)}))}],[e.directives.scope,(t,n)=>{n||console.error(t,`Use ${e.directives.scope}="insideWhat" format!`);const o=a[m(t)];if(o){const e=L(o,n);t.appendChild(e)}else t.setAttribute(e.directives.scope,`${e.doneSymbol}${n}`),y(I,n),C(t),E(I)}]],M=t=>{if(!t.hasAttribute)return;if(k.forEach((([n,o])=>{if(!t.hasAttribute(n))return;const r=t.getAttribute(n);r[0]!==e.doneSymbol&&(o(t,r),t.setAttribute(n,`${e.doneSymbol}${r}`))})),t.hasAttribute(e.directives.scope)||t.hasAttribute(e.directives.list))return;const n=m(t);c.call(a,n)&&t.appendChild(d(a[n]))},C=(e=document.body)=>(u(e,M),e),R=function(){const e=p(I);N.forEach((t=>{t(e)}))},D=(e,t)=>{$.forEach((n=>{n(e,t)}))};return{start:({startElement:e=document.body,initialFeed:t={},dataFunctions:n={}}={})=>{1!==e.nodeType&&console.error("start takes undefined or a node as first argument"),Object.assign(_,n),T("",t),C(e)},elements:r,functions:_,variables:o,get:(e,...t)=>o[b(e,...t)],element:(e,...t)=>r[b(e,...t)],feed:T,plugin:e=>{s(e)||console.error("plugin({\n                type,\n                plugin\n            });"),"function"===e.type?(A.push(e.plugin),j=(e,t,n)=>{let o=!1;const r=()=>{o=!0};A.forEach((o=>{o(e,t,n,_,r)})),o||P(e,t,n)}):"variable"===e.type?$.push(e.plugin):"cloned"===e.type?N.push(e.plugin):console.warn(`plugin type ${e.type} not yet implemented`)}}})(w);var D=Object.freeze({__proto__:null,start:function(e){e.on("WIN",(function(e){C("winLose","You WIN")})),e.on("LOSE",(function(e){C("winLose","You LOSE")})),e.on("MOVE",(function({distance:e,accuracy:t}){C("helpText",`Moved distance ${e} m  accuracy${t}`)})),e.on("DEBUG",(function(e){if(e.latitude){const{latitude:t,longitude:n}=e;C("debug",`DEBUG: latitude ${t} longitude ${n}`)}else e.code?C("debug",`DEBUG: code ${e.code} message ${e.message}`):C("debug",`DEBUG: ${e}`)}))}});const U=function(e){return a(e,(function(e){return e.id}))};var V=Object.freeze({__proto__:null,start:function(e){Object.assign(j,{submit:function(t){const n=Number(k("chosenProposal"));e.emit("PRISON",n)},talk:function(t){const n=U(t.target);e.emit("TALK",n)},prison:function(t){const n=U(t.target);e.emit("PRISON",n)}})}});const x=[[{backgroundColor:"grey"},{backgroundColor:"white"}],{duration:2e3,fill:"both"}],F=[[{transform:"rotate3d(0,0,0, 0)"},{transform:"rotate3d(0,1,0, 89.9deg)"}],{duration:4e3,fill:"both"}];var G=Object.freeze({__proto__:null,start:function(e){const t=new IntersectionObserver((t=>{t.forEach((t=>{t.intersectionRatio>=1?e.emit("MOVE_VIRTUALLY",{element:t.target}):t.intersectionRatio}))}),{threshold:[1,.7]});Array.from(document.getElementsByClassName("object")).forEach((e=>{t.observe(e)}))}});const B=e=>e*Math.PI/180;var X=Object.freeze({__proto__:null,start:function(e){let t,n=0;navigator.geolocation.watchPosition((function(o){const{latitude:r,longitude:s,accuracy:a}=o.coords;if(void 0!==t){const[o,i]=t;n+=function(e,t,n,o){const[r,s,a,i]=[e,t,n,o].map(B),c=Math.sin((r-a)/2)**2+Math.sin((s-i)/2)**2*Math.cos(r)*Math.cos(a);return 2*Math.atan2(c**.5,(1-c)**.5)*6378e3}(r,s,o,i),n>=5&&(e.emit("MOVE",{distance:n,accuracy:a}),n=0)}t=[r,s]}),(function(t){e.emit("DEBUG",t)}),{enableHighAccuracy:true,maximumAge:2e3})}});var H=Object.freeze({__proto__:null,start:function(e){e.on("CHANGE_PLACE",(function(e){e.animate(...x)})),e.on("GO_INSIDE",(function(e){e.animate(...F)})),e.on("GO_OUTSIDE",(function(e){e.animate(F[0],{...F[1],direction:"reverse"})}))}});const z={tips:["Il n'y a pas de fruits sans sucres","Tous les agrumes sont des fruits"],answer:3,proposals:["Il n'y pas de plante sucré qui ne soit un fruit","Tous les fruits sucrés sont également des agrumes","Les agrumes sans sucres ne sont pas des fruits","Tous les agrumes sont sucrés","Aucune des autres réponses"]};var W=Object.freeze({__proto__:null,start:function(e){let t;C({tips:z.tips.map((e=>({text:e}))),proposals:z.proposals.map(((e,t)=>({textContent:e,value:String(t)})))});let n=!1;e.on("PRISON",(function(t){t===z.answer?e.emit("WIN"):e.emit("LOSE")})),e.on("TALK",(function(e){C("conversation","10"===e?`${e} I am not a drug dealer ok !`:`${e} Arrest him !`)})),e.on("MOVE_VIRTUALLY",(function({element:n}){t=n,e.emit("CHANGE_PLACE",t)})),e.on("MOVE",(function(){t&&(n?(e.emit("GO_OUTSIDE",t.querySelector("img")),document.body.classList.remove("scroll-lock"),n=!1):(e.emit("GO_INSIDE",t.querySelector("img")),document.body.classList.add("scroll-lock"),n=!0))}))}});const K=new class{constructor(){this.paused=!1,this.moduleInstances=new Map,this.boundModuleEmit=this.moduleEmit.bind(this),e(this)}getState(e){if(!this.moduleInstances.has(e))return Promise.reject(`module with name ${e} does not exist`);const t=this.moduleInstances.get(e);return t.module.getState?Promise.resolve().then((()=>t.module.getState(t.instance))):Promise.resolve({})}getAllStates(){const e=[],t=[];return this.moduleInstances.forEach(((n,o)=>{e.push(this.getState(o)),t.push(o)})),Promise.all(e).then((e=>{const n={};return e.forEach(((e,o)=>{n[t[o]]=e})),n}))}restoreState(e,t){if(!this.moduleInstances.has(e))return Promise.reject(`module with name ${e} does not exist`);const o=this.moduleInstances.get(e);return o.module.restoreState?Promise.resolve().then((()=>{const e=n(t);return o.module.restoreState(o.instance,e)})):Promise.resolve()}restoreAllStates(e){return Promise.all(Object.entries(e).map((([e,t])=>this.restoreState(e,t))))}start(t,{name:n=Symbol()}={}){if(this.moduleInstances.has(n))return Promise.reject(`module with name ${n} already started`);if(!t.start)return Promise.reject("module must have start defined");const o=new e;return o.emit=this.boundModuleEmit,Promise.resolve().then((()=>t.start(o))).then((e=>{this.moduleInstances.set(n,{module:t,instance:e,name:n,emitter:o})})).then((()=>n)).catch((e=>{this.emit(r,{time:Date.now(),phase:"module.start",error:e})}))}stop(e){const t=this.moduleInstances.get(e);return t?(t.emitter.off(),Promise.resolve().then((()=>{this.moduleInstances.delete(e),t.module.stop&&t.module.stop(t.instance)})).catch((e=>{this.emit(r,{time:Date.now(),phase:"module.stop",error:e})})).then((()=>!0))):Promise.resolve(!1)}moduleEmit(e,t){this.paused||this.moduleEmitDirect(e,t)}moduleEmitDirect(t,n){this.emit(t,n),this.emit(o,{name:t,data:n,time:Date.now()}),this.moduleInstances.forEach((({emitter:o})=>{try{e.prototype.emit.call(o,t,n)}catch(e){this.emit(r,{time:Date.now(),phase:"module runtime (emitter.on)",error:e})}}))}};((e,{logger:t=console}={})=>{e.on(o,(({name:e,data:n,time:o})=>{const r=new Date(o).toISOString();t.debug(`${r} event ${String(e)} with data`,n)})),e.on(r,(({time:e,phase:t,error:n})=>{const o=new Date(e).toISOString();console.error(`Error during phase ${t} at ${o}`,n)}))})(K),(async()=>{await K.start(D),await K.start(V),await K.start(X),await K.start(W),await K.start(H),T({initialFeed:{title:"Hello World",superParagraph:"Super Paragraph text"}}),await K.start(G),setInterval((function(){K.moduleEmit("MOVE",{distance:30,accuracy:5})}),5e3)})();
