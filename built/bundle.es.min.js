function e(t){if((t||this)._callbacks=Object.create(null),t)return Object.assign(t,e.prototype)}e.prototype.on=function(e,t){(this._callbacks[e]=this._callbacks[e]||[]).push(t)},e.prototype.once=function(e,t){const n=o=>{this.off(e,n),t(o)};n.fn=t,this.on(e,n)},e.prototype.off=function(e,t){if(!e)return void(this._callbacks=Object.create(null));const n=this._callbacks[e];if(!n)return;if(!t)return void delete this._callbacks[e];const o=n.findIndex((function(e){return e===t||e.fn===t}));o>-1&&(1===n.length?delete this._callbacks[e]:n.splice(o,1))},e.prototype.emit=function(e,t){const n=this._callbacks[e];if(!n)return;Array.from(n).forEach((e=>{e(t)}))},e.prototype.listeners=function(e){return this._callbacks[e]||[]},e.prototype.hasListeners=function(e){return Boolean(this.listeners(e).length)},e.prototype.eventNames=function(){return Reflect.ownKeys(this._callbacks)},e.prototype.eventNamesStrings=function(){return Object.keys(this._callbacks)};const t=e=>{if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return e.map(t);const n={};return Object.entries(e).forEach((([e,o])=>{n[e]=t(o)})),n},n=e=>{if("object"!=typeof e||null===e)return e;if(e instanceof Date)return new Date(e);if(e instanceof RegExp)return new RegExp(e);if(e instanceof Set)return new Set(Array.from(e,n));if(e instanceof Map){const t=new Map;return e.forEach(((e,o)=>{t.set(n(o),n(e))})),t}if(Array.isArray(e))return e.map(t);if(ArrayBuffer.isView(e)&&!(e instanceof DataView))return new e.constructor(e);const o={};return Object.entries(e).forEach((([e,n])=>{o[e]=t(n)})),o},o=Symbol(),r=Symbol(),a=e=>"object"==typeof e&&null!==e,s=function(e,t){const n=t(e);if(n)return n;const o=e.parentNode;return o?s(o,t):void 0},i=(e,t,n)=>{Object.prototype.hasOwnProperty.call(e,t)?e[t].push(n):e[t]=[n]},{hasOwnProperty:c}=Object.prototype,l=e=>{e.remove()},u=(e,t)=>{t(e);let n=e.firstChild;for(;n;)1===n.nodeType?(u(n,t),n=n.nextElementSibling):n=n.nextSibling},d=e=>{const t=e.getAttribute("is");return t||e.tagName.toLowerCase()},m=e=>(e||console.error('Template missing <template data-template="d-name">\n                Template Content\n            </template>'),e.content||console.error("template.content is undefined, this can happen if a template is inside another template. Use only top level templates, also use recommended polyfills"),document.importNode(e.content,!0)),h=e=>e.join(">"),p=(e,t)=>0===e.length?t:`${h(e)}>${t}`,f=e=>e?`${e}>`:e,g=(e,t="")=>{Object.keys(e).forEach((n=>{n.startsWith(t)&&delete e[n]}))},b=(e,...t)=>{let n;return n=Array.isArray(e)?e.concat(t):[e,...t],h(n)},y=(e,t)=>{e.push(t)},v=e=>{e.pop()},E=(e,t,n)=>{t[e.propertyFromElement(t)]=n},S=(e,t,n,o,r,a)=>{c.call(e,"dom99_X")&&c.call(o,e.dom99_X)?r(e,t,n):A(e,n,a)},A=(e,t,n)=>{const o=document.createDocumentFragment();e.innerHTML="";const r=e.dom99_I,s=n.propertyFromElement(r.toUpperCase());t.forEach((e=>{const t=document.createElement(r);a(e)?Object.assign(t,e):t[s]=e,o.appendChild(t)})),e.appendChild(o)},_=e=>t=>Object.prototype.hasOwnProperty.call(e,t)?e[t]:e.MISS,I=_({INPUT:"value",TEXTAREA:"value",PROGRESS:"value",SELECT:"value",IMG:"src",SOURCE:"src",AUDIO:"src",VIDEO:"src",TRACK:"src",SCRIPT:"src",OPTION:"value",LINK:"href",DETAILS:"open",MISS:"textContent"}),O=_({checkbox:"checked",radio:"checked",MISS:"value"}),$=_({checkbox:"change",radio:"change",range:"change",file:"change",MISS:"input"}),w=_({SELECT:"change",TEXTAREA:"input",BUTTON:"click",FORM:"submit",MISS:"click"}),N={doneSymbol:"*",tokenSeparator:"-",listSeparator:" ",firstVariableValueStrategy:e=>e.value||(e=>void 0!==e.defaultValue?e.defaultValue:void 0!==e.open?e.open:e.textContent)(e),directives:{function:"data-function",variable:"data-variable",element:"data-element",list:"data-list",scope:"data-scope",template:"data-template",use:"data-use"},propertyFromElement:e=>{let t;return void 0!==e.tagName?({tagName:t}=e):t=e,"INPUT"===t?O(e.type):I(t)},eventNameFromElement:e=>{const{tagName:t}=e;return"INPUT"===t?$(e.type):w(t)},tagNamesForUserInput:["INPUT","TEXTAREA","SELECT","DETAILS"]},{start:T,elements:j,functions:P,variables:k,get:M,element:L,feed:R,plugin:C}=(e=>{const t={},n={},o={},r={},s={},A={};let _=[];const I=[];let O=!1;const $=[],w=[],N=(e,a,i)=>{const u=document.createDocumentFragment(),d=s[e.dom99_X],m=Array.from(_);_=a.split(">");const h=f(a),p=i.length;let b,y;if(c.call(e,"dom99_R")){if(b=e.dom99_R.length,b>p){for(let a=p;a<b;a+=1)y=`${h}${a}`,e.dom99_R[a].forEach(l),g(t,v=y),g(n,v),g(o,v),g(r,v);e.dom99_R.length=p}}else e.dom99_R=[],b=0;var v;i.forEach(((t,n)=>{if(y=`${h}${n}`,T(y,t),n<b)return;const o=k(d,String(n));e.dom99_R.push(Array.from(o.childNodes)),u.appendChild(o)})),_=m,e.appendChild(u)},T=(r,i)=>{if(void 0===i&&(i=r,r=""),a(r)&&console.error("Incorrect types passed to d.feed,\n                d.feed(string, object) or d.feed(object)"),O||(D(r,i),O=!0),a(i))if(Array.isArray(i))o[r]=i,c.call(n,r)&&((e,t,n,o,r,a)=>{e.forEach((e=>{S(e,t,n,o,r,a)}))})(n[r],r,i,s,N,e);else{const e=f(r),t=Object.entries(i);t.sort((([e,t],[n,o])=>Number(Array.isArray(o))-Number(Array.isArray(t)))),t.forEach((([t,n])=>{T(`${e}${t}`,n)}))}else o[r]=i,c.call(t,r)&&((e,t,n)=>{void 0!==n&&t.forEach((t=>{E(e,t,n)}))})(e,t[r],i);O=!1},j=(e,t,n)=>{A[n]||console.error(`Event listener ${n} not found.`),e.addEventListener(t,A[n],!1),_.length&&(e.dom99_C=h(_))};let P=j;const k=(e,t)=>{y(_,t);const n=m(e);return R(n),C(),v(_),n},M=[[e.directives.element,(t,n)=>{const o=n;o||console.error(t,`Use ${e.directives.element}="elementName" format!`);const a=p(_,o);r[a]=t}],[e.directives.template,(t,n)=>{if(n||console.error(t,`Use ${e.directives.template}="d-name" format!`),"TEMPLATE"!==t.tagName){const{innerHTML:e}=t;(t=document.createElement("template")).innerHTML=e}s[n]=t}],[e.directives.list,(t,r)=>{const[a,l,u]=r.split(e.tokenSeparator);if(a||console.error(t,`Use ${e.directives.list}="variableName-tagName" format!`),l){let e;u?(e=`${l}-${u}`,t.dom99_X=e):t.dom99_I=l;const n=t.tagName.toLowerCase();console.warn(`deprecated since 21.0.1\nReplace <${n} data-list="${a}-${e||l}"></${n}> with\n<${n} data-list="${a}" data-use="${e||l}"></${n}>`)}else{const n=t.getAttribute(e.directives.use);n.includes("-")?t.dom99_X=n:t.dom99_I=n}const d=p(_,a);if(i(n,d,t),t.childNodes.length>0){y(_,a);const e=Array.from(t.childNodes).filter((e=>1===e.nodeType)),n=h(_);void 0===o[n]&&(o[n]=Array.from({length:e.length},(()=>({})))),t.dom99_R=[],e.forEach(((e,n)=>{y(_,String(n)),R(e),t.dom99_R.push([e,...e.childNodes]),v(_)})),v(_)}c.call(o,d)&&S(t,d,o[d],s,N,e)}],[e.directives.variable,(n,r)=>{r||console.error(n,`Use ${e.directives.variable}="variableName" format!`);const a=p(_,r);i(t,a,n);let s=o[a];if(void 0===s&&void 0!==e.firstVariableValueStrategy&&(s=e.firstVariableValueStrategy(n)),void 0!==s&&(o[a]=s,E(e,n,s)),!e.tagNamesForUserInput.includes(n.tagName))return;n.addEventListener(e.eventNameFromElement(n),(()=>{const r=n[e.propertyFromElement(n)];o[a]=r,D(a,r),t[a].forEach((t=>{t!==n&&E(e,t,r)}))}),!1)}],[e.directives.function,(t,n)=>{n.split(e.listSeparator).forEach((n=>{const o=n.split(e.tokenSeparator);let r,a;1===o.length?(r=o[0],a=e.eventNameFromElement(t)):[a,r]=o,P(t,a,r)}))}],[e.directives.scope,(t,n)=>{n||console.error(t,`Use ${e.directives.scope}="insideWhat" format!`);const o=s[d(t)];if(o){const e=k(o,n);t.appendChild(e)}else t.setAttribute(e.directives.scope,`${e.doneSymbol}${n}`),y(_,n),R(t),v(_)}]],L=t=>{if(!t.hasAttribute)return;if(M.forEach((([n,o])=>{if(!t.hasAttribute(n))return;const r=t.getAttribute(n);r[0]!==e.doneSymbol&&(o(t,r),t.setAttribute(n,`${e.doneSymbol}${r}`))})),t.hasAttribute(e.directives.scope)||t.hasAttribute(e.directives.list))return;const n=d(t);c.call(s,n)&&t.appendChild(m(s[n]))},R=(e=document.body)=>(u(e,L),e),C=function(){const e=h(_);w.forEach((t=>{t(e)}))},D=(e,t)=>{$.forEach((n=>{n(e,t)}))};return{start:({startElement:e=document.body,initialFeed:t={},dataFunctions:n={}}={})=>{1!==e.nodeType&&console.error("start takes undefined or a node as first argument"),Object.assign(A,n),T("",t),R(e)},elements:r,functions:A,variables:o,get:(e,...t)=>o[b(e,...t)],element:(e,...t)=>r[b(e,...t)],feed:T,plugin:e=>{a(e)||console.error("plugin({\n                type,\n                plugin\n            });"),"function"===e.type?(I.push(e.plugin),P=(e,t,n)=>{let o=!1;const r=()=>{o=!0};I.forEach((o=>{o(e,t,n,A,r)})),o||j(e,t,n)}):"variable"===e.type?$.push(e.plugin):"cloned"===e.type?w.push(e.plugin):console.warn(`plugin type ${e.type} not yet implemented`)}}})(N);var D=Object.freeze({__proto__:null,start:function(e){e.on("WIN",(function(e){R("helpText","You WIN")})),e.on("LOSE",(function(e){R("helpText","You LOSE")})),e.on("MOVE",(function({distance:e,accuracy:t}){R("helpText",`Moved distance ${e} m  accuracy${t}`)})),e.on("DEBUG",(function(e){const{latitude:t,longitude:n}=e;R("debug",`DEBUG: latitude ${t} longitude ${n}`)}))}});const U=function(e){return s(e,(function(e){return e.id}))};var x=Object.freeze({__proto__:null,start:function(e){Object.assign(P,{talk:function(t){const n=U(t.target);e.emit("TALK",n)},prison:function(t){const n=U(t.target);e.emit("PRISON",n)}})}});var F=Object.freeze({__proto__:null,start:function(e){const t=new IntersectionObserver((e=>{e.forEach((e=>{e.intersectionRatio>0?(console.log(e.target),e.target===j.end?e.target.insertAdjacentHTML("beforebegin","<h2 data-element>LOL</h2>"):e.target.insertAdjacentHTML("afterend","<h2 data-element>LOL</h2>"),console.log("is visible")):(console.log(e.target),console.log("not visible"))}))}),{threshold:[0,1]});[j.begin,j.end].forEach((e=>{t.observe(e)}));const n=new IntersectionObserver((e=>{e.forEach((e=>{e.intersectionRatio>=.8?(e.target.animate([{backgroundColor:"grey"},{backgroundColor:"white"}],{duration:2e3,fill:"both"}),console.log("is largely visible")):e.intersectionRatio<=.7&&(console.log("not so visible"),e.target.animate([{backgroundColor:"white"},{backgroundColor:"grey"}],{duration:2e3,fill:"both"}))}))}),{threshold:[.8,.7]});Array.from(document.getElementsByClassName("object")).forEach((e=>{n.observe(e)}))}});const V=e=>e*Math.PI/180;var X=Object.freeze({__proto__:null,start:function(e){let t;navigator.geolocation.watchPosition((function(n){const{latitude:o,longitude:r,accuracy:a}=n.coords;if(e.emit("DEBUG",{latitude:o,longitude:r}),void 0!==t){const[n,s]=t,i=function(e,t,n,o){const[r,a,s,i]=[e,t,n,o].map(V),c=Math.sin((r-s)/2)**2+Math.sin((a-i)/2)**2*Math.cos(r)*Math.cos(s);return 2*Math.atan2(c**.5,(1-c)**.5)*6378e3}(o,r,n,s);e.emit("MOVE",{distance:i,accuracy:a})}t=[o,r]}),console.error,{enableHighAccuracy:!0,maximumAge:2e3})}});var B=Object.freeze({__proto__:null,start:function(e){e.on("PRISON",(function(t){"10"===t?e.emit("WIN"):e.emit("LOSE")})),e.on("TALK",(function(e){R("conversation","10"===e?`${e} I am not a drug dealer ok !`:`${e} Arrest him !`)}))}});const H=new class{constructor(){this.paused=!1,this.moduleInstances=new Map,this.boundModuleEmit=this.moduleEmit.bind(this),e(this)}getState(e){if(!this.moduleInstances.has(e))return Promise.reject(`module with name ${e} does not exist`);const t=this.moduleInstances.get(e);return t.module.getState?Promise.resolve().then((()=>t.module.getState(t.instance))):Promise.resolve({})}getAllStates(){const e=[],t=[];return this.moduleInstances.forEach(((n,o)=>{e.push(this.getState(o)),t.push(o)})),Promise.all(e).then((e=>{const n={};return e.forEach(((e,o)=>{n[t[o]]=e})),n}))}restoreState(e,t){if(!this.moduleInstances.has(e))return Promise.reject(`module with name ${e} does not exist`);const o=this.moduleInstances.get(e);return o.module.restoreState?Promise.resolve().then((()=>{const e=n(t);return o.module.restoreState(o.instance,e)})):Promise.resolve()}restoreAllStates(e){return Promise.all(Object.entries(e).map((([e,t])=>this.restoreState(e,t))))}start(t,{name:n=Symbol()}={}){if(this.moduleInstances.has(n))return Promise.reject(`module with name ${n} already started`);if(!t.start)return Promise.reject("module must have start defined");const o=new e;return o.emit=this.boundModuleEmit,Promise.resolve().then((()=>t.start(o))).then((e=>{this.moduleInstances.set(n,{module:t,instance:e,name:n,emitter:o})})).then((()=>n)).catch((e=>{this.emit(r,{time:Date.now(),phase:"module.start",error:e})}))}stop(e){const t=this.moduleInstances.get(e);return t?(t.emitter.off(),Promise.resolve().then((()=>{this.moduleInstances.delete(e),t.module.stop&&t.module.stop(t.instance)})).catch((e=>{this.emit(r,{time:Date.now(),phase:"module.stop",error:e})})).then((()=>!0))):Promise.resolve(!1)}moduleEmit(e,t){this.paused||this.moduleEmitDirect(e,t)}moduleEmitDirect(t,n){this.emit(t,n),this.emit(o,{name:t,data:n,time:Date.now()}),this.moduleInstances.forEach((({emitter:o})=>{try{e.prototype.emit.call(o,t,n)}catch(e){this.emit(r,{time:Date.now(),phase:"module runtime (emitter.on)",error:e})}}))}};((e,{logger:t=console}={})=>{e.on(o,(({name:e,data:n,time:o})=>{const r=new Date(o).toISOString();t.debug(`${r} event ${String(e)} with data`,n)})),e.on(r,(({time:e,phase:t,error:n})=>{const o=new Date(e).toISOString();console.error(`Error during phase ${t} at ${o}`,n)}))})(H),(async()=>{await H.start(D),await H.start(x),await H.start(X),await H.start(B),T({initialFeed:{title:"Hello World",superParagraph:"Super Paragraph text"}}),await H.start(F)})();
